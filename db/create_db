#!/bin/bash

# stop on error

set -e

# how to connect

#CLUSTER='--cluster 9.5/main'
CLUSTER=''

# what to create

DBNAME='jc2'
JC='jc2'
JCADMIN="${JC}_admin"
JCCLIENT="${JC}_client"
JCMAESTRO="${JC}_maestro"
JCSPERL="${JC}_perl"
JCSYSTEM="${JC}_system"
DEFPW='geheimnis'

# create

psql $CLUSTER -x -e -v ON_ERROR_STOP=1 << EOF

SET default_transaction_read_only = off;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;

--
-- Roles
--

DO
\$body\$
BEGIN
	IF NOT EXISTS (SELECT 1 FROM pg_catalog.pg_roles WHERE rolname = '$JCADMIN') THEN
		CREATE ROLE $JCADMIN;
		ALTER ROLE $JCADMIN WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION NOBYPASSRLS PASSWORD '$DEFPW';
	END IF;		

	IF NOT EXISTS (SELECT 1 FROM pg_catalog.pg_roles WHERE rolname = '$JCCLIENT') THEN
		CREATE ROLE $JCCLIENT;
		ALTER ROLE $JCCLIENT WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION NOBYPASSRLS PASSWORD '$DEFPW';
		GRANT $JCCLIENT TO $JCADMIN;
	END IF;		

	IF NOT EXISTS (SELECT 1 FROM pg_catalog.pg_roles WHERE rolname = '$JCMAESTRO') THEN
		CREATE ROLE $JCMAESTRO;
		ALTER ROLE $JCMAESTRO WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB LOGIN NOREPLICATION NOBYPASSRLS PASSWORD '$DEFPW';
	END IF;		

	IF NOT EXISTS (SELECT 1 FROM pg_catalog.pg_roles WHERE rolname = '$JCSYSTEM') THEN
		CREATE ROLE $JCSYSTEM;
		ALTER ROLE $JCSYSTEM WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB NOLOGIN NOREPLICATION NOBYPASSRLS;
		GRANT $JCSYSTEM TO $JCADMIN;
	END IF;		

	IF NOT EXISTS (SELECT 1 FROM pg_catalog.pg_roles WHERE rolname = '$JCPERL') THEN
		CREATE ROLE $JCPERL;
		ALTER ROLE $JCPERL WITH NOSUPERUSER INHERIT NOCREATEROLE NOCREATEDB NOLOGIN NOREPLICATION NOBYPASSRLS;
		GRANT $JCSPERL TO $JCSYSTEM;
	END IF;		
END
\$body\$;

EOF

if [[ `psql $CLUSTER -tAc "SELECT 1 FROM pg_database WHERE datname='$DBNAME'"` == "1" ]]
then
	echo 'Database $DBNAME already exists'
	exit 1
else
	echo "Creating database $DBNAME"
	psql $CLUSTER -x -e -v ON_ERROR_STOP=1 -c "CREATE DATABASE $DBNAME WITH TEMPLATE = template0 OWNER = $JCSYSTEM"
fi

psql $CLUSTER -x -e -v ON_ERROR_STOP=1 << EOF
REVOKE ALL ON DATABASE $DBNAME FROM PUBLIC;
REVOKE ALL ON DATABASE $DBNAME FROM $JCCLIENT;
REVOKE ALL ON DATABASE $DBNAME FROM $JCMAESTRO;
REVOKE ALL ON DATABASE $DBNAME FROM $JCPERL;
REVOKE ALL ON DATABASE $DBNAME FROM $JCSYSTEM;
GRANT ALL ON DATABASE $DBNAME TO $JCADMIN;
GRANT CONNECT ON DATABASE $DBNAME TO $JCCLIENT;
GRANT CONNECT ON DATABASE $DBNAME TO $JCMAESTRO;
GRANT CONNECT ON DATABASE $DBNAME TO $JCPERL;
GRANT CONNECT ON DATABASE $DBNAME TO $JCSYSTEM;
ALTER DATABASE $DBNAME SET search_path TO jobcenter, pg_catalog, pg_temp;

\connect $DBNAME

CREATE EXTENSION IF NOT EXISTS plpgsql WITH SCHEMA pg_catalog;
COMMENT ON EXTENSION plpgsql IS 'PL/pgSQL procedural language';

CREATE EXTENSION IF NOT EXISTS plperl WITH SCHEMA pg_catalog;
COMMENT ON EXTENSION plperl IS 'PL/Perl procedural language';

EOF

